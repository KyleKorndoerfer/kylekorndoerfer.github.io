<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Migrating to Azure.Messaging.EventGrid | Developer Meanderings</title><meta name=description content="There are a few gotchas when migrating from Microsoft.Azure.EventGrid to the Azure.Messaging.EventGrid package."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Migrating to Azure.Messaging.EventGrid"><meta name=twitter:description content="There are a few gotchas when migrating from Microsoft.Azure.EventGrid to the Azure.Messaging.EventGrid package."><meta property="og:title" content="Migrating to Azure.Messaging.EventGrid"><meta property="og:description" content="There are a few gotchas when migrating from Microsoft.Azure.EventGrid to the Azure.Messaging.EventGrid package."><meta property="og:type" content="article"><meta property="og:url" content="https://korndoerfer.dev/posts/2023/02/02-migrating_eventgrid_mesaging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-02T00:00:00+00:00"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script>
<link rel=apple-touch-icon href=/apple-touch-icon.png><link rel="shortcut icon" href=/favicon.png type=image/x-icon><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=icon href=/logo.svg sizes=any type=image/svg+xml></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://korndoerfer.dev/>Developer Meanderings</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/about/ title=About>About</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/c#/ title=C#>C#</a>
<a class=tag href=/tags/azure/ title=Azure>Azure</a>
<a class=tag href=/tags/eventgrid/ title=EventGrid>EventGrid</a></div><h1>Migrating to Azure.Messaging.EventGrid</h1><h2 class=subheading></h2><span class=meta>Posted by
on Thu, Feb 2, 2023</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Recently we started updating an Azure Functions project that processes dead letter
messages from EventGrid that couldn&rsquo;t be delivered to our Azure Storage Queues. As
part of the upgrade we migrated from the deprecated <code>Microsoft.Azure.EventGrid</code>
library to the <code>Azure.Messaging.EventGrid</code> library and came across a few differences
that required somce changes to our code.</p><h2 id=getting-the-eventgridevents-from-the-blob-trigger>Getting the EventGridEvents from the blob trigger<a class=anchorjs-link href=#getting-the-eventgridevents-from-the-blob-trigger></a></h2><p>Previously, we used the <code>Newtonsoft.JSON</code> library to deserialize the data passed
to the blob trigger as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>[FunctionName(&#34;DeadLetterProcessing&#34;)]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Run(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#a6e22e>		[BlobTrigger(_blobPath, Connection = _conn)]</span> <span style=color:#66d9ef>string</span> myBlob,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>		<span style=color:#66d9ef>string</span> name,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>		ILogger log)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    EventGridEvent[] _events = JsonConvert.DeserializeObject&lt;EventGridEvent&gt;(myBlob);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>	<span style=color:#75715e>// etc.</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><p>However, using the new library the <code>EventGridEvent</code> type no longer has a default
constructor that allows you to deserialize the JSON data directly. Instead, you
need to use static methods on the <code>EventGridEvent</code> type to process the data as
follows:</p><ul><li><code>EventGridEvent.Parse()</code> for a single event</li><li><code>EventGridEvent.ParseMany()</code> for multiple events</li></ul><p>When processing dead letter events from EventGrid, it will <em>always</em> be an array
of at least 1 event, so we will need to use the <code>ParseManu()</code> method.</p><p>We will also need to use the static methods on the <code>BinaryData</code> type to process
the data received by the blob trigger into a <code>BinaryData</code> type.:</p><ul><li><code>BinaryData.FromString()</code> if you used the <code>string</code> binding option on the blob trigger</li><li><code>BinaryData.FromStream()</code> if you used the <code>Stream</code> binding option on the blo trigger</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>[FunctionName(&#34;DeadLetterProcessing&#34;)]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> Run(
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#a6e22e>        [BlobTrigger(_blobPath, Connection = _conn)]</span>Stream myBlob,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        <span style=color:#66d9ef>string</span> name,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>        ILogger log)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    EventGridEvent[] _events = EventGridEvent.ParseMany(BinaryData.FromStream(myBlob));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><h2 id=getting-the-custom-data-from-the-eventgrideventdata-property>Getting the custom data from the <code>EventGridEvent.Data</code> property<a class=anchorjs-link href=#getting-the-custom-data-from-the-eventgrideventdata-property></a></h2><p>The next issue we encountered is trying to deserialize the custom data stored in
the <code>Data</code> property of the <code>EventGridEvent</code>. Again, we used to just deserialize
the <code>Data</code> property directly but this is no longer an object type, but rather a
<code>BinaryData</code> type.</p><p>This means that we need to use the <code>.ToObjectFromJson&lt;T>()</code> method of the
<code>BinaryData</code> type to process the custom data property into our custom data object.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>EventGridEvent[] _events = EventGridEvent.ParseMany(BinaryData.FromString(myBlob));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#66d9ef>foreach</span> (EventGridEvent eventGridEvent <span style=color:#66d9ef>in</span> _events)
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    CustomEventGridData data = eventGridEvent.Data.ToObjectFromJson&lt;CustomEventGridData&gt;();
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#75715e>// use you data as needed</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>Of particular note, the new library makes use of <code>System.Text.Json</code> to serialize
the custom data. This means that you need to switch to using the <code>JsonPropertyName</code>
attribute on your data classes in order to deserialize the data properly.</p><p>Hence our custom data object need to be updated as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#66d9ef>using</span> System.Text.Json.Serialization;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomEventGridData</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#a6e22e>    [JsonPropertyName(&#34;orderNumber&#34;)]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> OrderNumber { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#a6e22e>
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#a6e22e>    [JsonPropertyName(&#34;orderTotal&#34;)]</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> OrderTotal { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>}
</span></span></code></pre></div><h1 id=wrap-up>Wrap up<a class=anchorjs-link href=#wrap-up></a></h1><p>None of this was hard, but we needed to pay closer attention to the changes
described in <a href=https://aka.ms/azsdk/net/migrate/eg target=_blank>Migration Guide</a> that was
linked from the deprecation notice on the old <code>Microsoft.Azure.EventGrid</code> library.
However, the portion that applied to our situation was a couple of small paragraphs
near the end of the document while the rest seemed more focused on the support
for the <code>CloudEvent</code> type from <code>Azure.Core</code>&mldr; a standardized event type from the
<a href=https://cncf.io/projects/cloudevents target=_blank>Cloud Native Computing Foundation</a>.
Details of the specification can be found at <a href=https://cloudevents.io target=_blank>cloudevents.io</a>.</p><p>Hopefully this helps someone else switching to the new library find what they are
looking for quicker!</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/posts/2022/12/22-custom-exception-serialization/ data-toggle=tooltip data-placement=top title="Custom Exceptions and Serialization">Previous<br><span>Custom Exceptions and Serialization</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/.net/>.NET</a>
<a href=/tags/azure/>Azure</a>
<a href=/tags/c#/>C#</a>
<a href=/tags/cosmosdb/>CosmosDB</a>
<a href=/tags/eventgrid/>EventGrid</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=https://github.com/KyleKorndoerfer target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/KyleKorndoerfer target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://hachyderm.io/kylek target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-mastodon fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">S. Kyle Korndoerfer<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/js/simple-jekyll-search.min.js></script>
<script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script>
<script src=/zoomjs/zoom.min.js></script></body></html>